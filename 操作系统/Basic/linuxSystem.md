## # 进程管理 ##

进程就是正在运行的程序

使用'ps aux'命令查看进程

进程管理的的作用：

1. 判断服务器的健康状况
2. 查看系统中的所有进程
3. 杀死进程 (最不重要，只有不得已的情况下才使用)

### 进程的查看 ###

注：如果遇到特别消耗资源的进程，又不知道是什么，最好百度一下，不要盲目中止。

命令：

ps aux : 查看系统中的所有进程，使用BSD操作系统格式

ps -le ：查看系统中的所有进程，使用linux标准命令格式

选项：

-- a : 显示一个终端的所有进程，除了会话引线

-- u : 显示进程的归属用户及内存的使用情况

-- x : 显示没有控制终端的进程

-- -e: 显示所有进程，和-A作用一样

-- -l: 长格式显示，显示更加详细的信息

取一条进程分析：

USER: 经常的产生的用户

PID ：进程id

%CPU:cpu占比

%MEN：内存占比

VSZ ：进程占用的虚拟内存,单位KB

RSS : 进程占用的实际物理内存的大小，单位KB

TYY : 该进程是在哪个终端中运行。其中tyy1~tyy7代表本地控制台终端，tyy1~tyy6是本地字符终端，tyy7是图形终端，pts/0~255代表虚拟终端，也就是远程终端，如果是'?',则说明不是由终端启动的，是系统进程。

STAT: 进程的状态，常见的状态有：R: 运行，S：睡眠，T：停止运行，s：包含子进程，+：位于后台。(还有很多状态，这里只是常见的)

START: 该进程的启动时间

TIME: 该进程占用cup的时间，注意不是系统时间

COMMAND: 产生次进程的命令名(也叫进程名)

<br />

查看进程树：pstree [选项]

选项：

-p : 显示进程的PID

-u : 显示进程所属用户


### 查看系统的健康状态 ###

命令：top [选项]

选项：

-- -d : 秒数，指定top几秒刷新，默认是3秒刷新

-- -b : 使用批处理模式输出。一般和'-n'选项合用。

-- -n : 次数，指定top命令执行的次数，一般和'-b'选项合用。

在top命令的交互模式中可以使用的常用命令：

? 或 h ：显示交互模式的帮助。

p      : 以cpu使用率排序（默认）

M      : 以内存的使用率排序

N      : 以PID排序

q      : 退出top

<br>

#### 健康状况检查：解析top命令结果的前5行(重要) ####

1. 第一行：任务队列信息

   12:26:45 : 当前系统时间

   up 1 day, 13:32 : 系统的运行时间，这里显示的是本机已经运行的一天13小时32分，不要刻意追求时长，应该定期重启服务器。

   2 user : 当前登录了两个用户

   load average : 0.00, 0.00, 0.00 : 系统在之前1分钟，5分钟，15分钟的平均负载。根据系统的核数来判断，主要还是经验判断。

2. 第二行

   'Tasks: 95 total' : 系统中进程的总数

   1 running : 正在进行的进程

   94 sleeping : 睡眠的进程

   0 stopped : 正在停止的进程

   0 zombie : 僵尸进程，如果不是0，需要手工检查僵尸进程。

3. 第三行

   'Cpu(s): 0.1%us' : 用户模式占用的cpu百分比

   0.1%sy : 系统模式占用的cpu百分比

   0.0%ni : 改变过优先级的用户进程占用的cpu百分比

   99.7%id : 空闲cpu的cpu百分比

   0.1%wa : 等待输入输出的进程的占用cpu百分比

   0.1%hi : 硬中断请求服务的占用的cpu百分比

   0.1%si : 软中断请求服务的占用的cpu百分比

   0.1%st : st(Steal time)虚拟时间百分比，就是当有虚拟机时，虚拟cpu等待实际cpu的时间百分比

4. 第四行

   'Mem: 625334k total' : 物理内存的总量，单位KB

   571504k used : 已经使用的物理内存数量

   53840k free : 空闲的物理内存数量

   65800k buffers : 作为缓冲的内存数量(buffers是缓冲加速了数据的写入，而cached是缓存，加速了数据的读取)

5. 第五行

   'Swap: 524280k total' : 交换分区(虚拟内存的总大小)，单位KB

   0k used : 已经使用的虚拟内存的大小

   524280k free : 空闲的虚拟内存的大小

   409280k cached : 作为缓存的交换分区的大小

### 杀死进程 ###

注：不要轻易杀死进程，除非正常关闭进程不起作用了

杀死单进程：

使用kill -l命令查看，杀死进程信号。

常用的信号：
信号代号：1  信号名称：SIGHUB 说明：该信号让进程立即关闭，然后重新读取配置文件之后重启，这其实是所谓的“平滑重启”，就是重启服务而又中止用户使用服务。 命令格式：kill -1(或者-HUB) 进程id(进程名的话是不会执行的)

信号代号：9 信号名称：SIGKILL 说明：用来立即结束进程的运行，本信号不能被阻塞、处理和忽略。一般用于强制中止程序(只有信号15用不了的时候采用此信号)

信号代号：15 信号名称：SIGTERM 说明：正常结束进程的信号，kill默认信号，有时候进程已经发生了问题这个信号是无法中止进程的，就需要用信号9了。

杀死多个进程：

killall命令：killall [选项] [信号] 进程名   （按照进程名杀死一系列进程）

选项：-i: 交互式，询问是否要杀死某个进程

-I: 忽略进程名的大小写

pkill命令：pkill [选项] [信号] 进程名  （按照进程名杀死一系列进程）

选项：

-t: 终端号：按照终端号踢出用户，不会不自己踢了(普通用户不能踢出超级用户，超级用户可以互踢)，例：pkill -9 -t 终端号(如：tty1、pts/0等)

### 修改进程优先级 ###

注：一般不会修改优先级，因为cpu运算很快，基本区分不了，除非是在做内核裁剪和嵌入式开发的项目，否则修改优先级基本没什么作用。

知识点整理：优先级查看方法：ps -le

PRI代表Priority(主要的优先级，用户不可修改), NI代表Nice(次要优先级，用户可以修改)。这两个值都是优先级，数字越小代表该进程优先级越高，系统按PRI和NI优先级之和来定进程优先级的。

修改优先级时的几个注意点：

1. NI的值范围是-20~19。
2. 普通用户调整NI的值的范围是0~19，而且只能调整自己的进程。
3. 普通用户只能调高NI值，不能降低。
4. root用户才能设点进程NI为负值，而且可以调整任何用户的进程。
5. PRI(最终值) = PRI(原始值) + NI
6. 用户只能修改NI值，不能直接修改PRI。

修改进程命令：nice [选项] 命令。(不能修改正在进行的进程，只能改新进程，也就是还没有运行，即将要运行的进程，一般在启动进程命令时修改。)

选项：

-n NI值：给命令赋予NI值。

例如：nice -n -5 service httpd start  (启动apache,并将该进程的NI值赋为-5)

修改已经存在的进程命令：renice

格式：renice [优先级] PID (修改已经存在的的进程的优先级，PID：进程id)

例如：renice -10 2125   (修改PID为2125的进程的优先级NI为-10)

## # 工作管理 ##

工作管理指的是：单个登录终端中(也就是登录的shell界面中)同时管理多个工作的行为。为什么需要将进程放入后台运行呢？因为有的服务进程会执行很长时间，会一直卡着界面，这个时候只有将该服务放入后台启动，才能执行其它的命令(工作管理就是后台进程管理)

注意式事项：

1. 当前的登录终端，只能管理当前终端的工作。
2. 放入后台的命令必须可以运行一段时间，这样才能捕捉和操作这个工作。(学习过程中)
3. 放入后台执行的命令不能和前台用户有交互或需要前台输入，否则放入后台只能暂停不能执行。

### 将进程放入后台的两种方法 ###

1. 在命令后加 &符：如：tar -zcf etc.tar.gz /etc & : 把命令放入后台，并在后台执行，前提是满足后台运行条件，否则不管用什么命令将进程放入后台，进程都是暂停状态。
2. 按下ctrl + z 快捷键，将进程放入后台暂停。
3. 查看工作后台的命令：
   jobs [选项]
   选项：
   -l:显示工作的PID
   注：“+”号代表最近一个放入后台的工作，也是工作恢复时，默认恢复的工作。“-”号代表倒数第二个放入后台的工作。

4. 将暂停的工作恢复到前台执行：
   命令：fg %工作号
   参数：%工作号：%可以省略不写，但是注意工作号和PID的区别

5. 将暂停的工作恢复到后台执行：
   命令：bg %工作号
   注：后台恢复执行的工作，是不能和前台用户有交互的，否则不能恢复到后台执行。

### 后台命令脱离登录终端执行 ###

简介：把命令放入后台，只能在当前终端执行，一旦退出或关闭终端，后台程序就会停止。

后台命令脱离登录终端执行的方法：

1. 把需要后台执行的命令加入/etc/rc.local文件中。(推荐做法)
2. 使用系统做定时任务，让系统在指定的时间执行某个后台命令(有时可能会不生效)
3. 使用nohub命令。(标准做法，推荐)
4. 屏蔽kill信号，我们退出终端的时候是系统默认是使用kill的SIGHUP信号把我们当前终端的后台工作关闭中止的，所以我们只要屏蔽kill信号就可以保留后台工作，但是这涉及到linux内核编程，所以不推荐使用。

/etc/rc.local文件解析：每次系统启动系统都会执行一遍该文件中的内容，启动时间就是在该文件中获取的。

例子：

现在写一个脚本，该脚本是执行一个for循环，过程和内容如下：

vim /root/for.sh （其内容如下）

```
\#!/bin/bash
for((i=1;i<=1000;i++>))
  do
  	echo 1111 >> /root/for.log
  	sleep 10
  done
```

保存文件并退出，然后设置文件权限(命令：chmod 755 /root/for.sh)，然后将该文件用可以脱离登录终端执行的方法放入后台执行(命令：nohup /root/for.sh)，关闭当前终端，打开另外一个新的终端，然后查看进程，就会看到/root/for.sh这段程序还在执行，并内有被关闭。


## # 系统资源查看 ##

1. 命令1：
vmstat [多久刷新一次] [总共刷新多少次] （常用，建议记下来）

2. 命令2：
dmesg : 开机时内核检查信息(但是信息很多，所以我们可以用管道符来连接一个查询命令，如：dmesg | grep cpu) （常用，建议记下来）

3. 命令3：
free [-b|-k|-m|-g] （常用，建议记下来）
选项：
-b : 以字节为单位显示
-k : 以KB为单位显示(默认)
-m : 以MB为单位显示
-g : 以GB为单位显示

4. 查看cpu信息：(cpu信息是在/proc/cpuinfo文件中。这里/proc/ 目录是用来保存内存中的信息的地方，cpu的信息就放在内存里，所以cpu信息也在里面)
cat /proc/cpuinfo

5. uptime命令：显示系统的启动时间和平均负载，也就是top命令的第一行，w命令也可以看到这个信息。(因为top命令比较消耗系统资源，所以如果我们知识想看系统的启动时间和平均负载的话可以使用此命令或者w命令。)

6. 查看系统与内核相关信息
uname [选项]
选项：
-a ：查看系统所有相关信息
-r ：查看内核版本
-s ：查看内核名称。
注意：这里看的是内核版

7. 查看当前系统的位数：这里使用一个小技巧，就是随便找一个外部命令，它会告诉你，这个命令是多少位的，你的操作系统的位数和它一样，用此来判断你的操作系统的位数，还有其它的查看方式，但这个是最简单的，注意cpuinfo中的位数是系统硬件位数，不是操作系统位数，比如，64位的硬件里面还是可以安装32位的系统。
命令是：file /bin/ls

8. 查看当前Linux系统的发行版本
注：这里看的是发行版
lsb_release -a

备注：linux分位内核版和发行版，内核版就是由内核官网发布的，任何人都可以用，发行版就是某些企业或个人在内核版的基础上进行优化后发行的版本就叫发行版。

9. 列出进程打开或使用的文件信息
lsof [选项]  ： 列出进程调用或打开的文件信息
选项： 
-c 字符串 ：只列出以字符串开头的进程打开的文件
-u 用户名 ：只列出某个用户的进程打开的文件
-p pid   ：列出某个PID进程打开的文件

## # 系统定时任务 ##

背景：为什么我们需要定时任务？一般来说linux系统我们是用作应用的服务器的，所以白天的时候相较于晚上就会有很多用户访问，这个时候服务器也就是系统负载是很大的，如果我们在执行一些很耗资源的命令的话，很可能就会导致服务器崩溃，所以我们要在晚上做一些定时任务，避开用户访问高峰期。

### 单次定时任务（重要） ###

1. 检查at服务是否安装
chkconfig --list | grep atd （这是centos7之前的查看方式，centos7之后的是systemctl list-unit-files | grep atd）

2. at服务启动
service atd restart
知识点整理：为什么很多服务后面都有字符'd',这里字符'd'表示位守护进程的意思，证明将这个进程当成系统的服务安装在了系统的后台当中。看到这个'd',就把这个服务当作系统服务。

3. at的访问控制：如果系统中有/etc/at.allow,这是at命令的白名单，文件中的用户可以使用（有这个文件的话忽略系统中的/etc/at.deny,这个是at的黑名单，里面的用户可以使用at，这个文件只有在没有/etc/at.allow的时候生效，对root没有作用），如果两个文件都没有的话，默认只有root用户有使用权限。默认是有/etc/at.deney文件
注：/etc/at.allow和/etc/at.deney这种机制在linux中是很常见的，所以作用以此类推。

4. at命令
at [选项] 时间 （常用的是不加选项）
选项：
-m ：当at工作完成后，无论命令是否有输出，都用email通知执行at的命令的用户。
-c 工作号 ：显示该at工作的实际内容。
时间：
-HH:MM   如：02:30
-HH:MM YYYY-MM-DD   如：02:30 2013-07-25
-HH:MM[am|pm] [month] [date]  如：02:30 july 25
-HH:MM[am|pm] + [minutes|hours|days|weeks]  如：now + 5 minutes
例子1：at now + 2 minutes （这是指在两分钟后执行）
at> /root/hello.sh >> /root/hello.log  （系统会出现'at>',然后我们可以在'at>'后输入我们要执行的工作，输完后回车，然后ctrl + d,保存并退出'at>'界面）

例子2：在指定的时间重启系统(这里知识个例子，实际生活中是不建议，实际生活中应该人工完成系统重启，避免出现问题而又没有及时解决)
at 02:00 2019-7-28
at> /bin/syns  （数据同步，内存中的数据往硬盘上转移）
at> /sbin/shutdown -r now  (重启)

5. 查看系统中的at定时任务
命令：atq   (查询当前服务器上的at工作)
命令：at -c 工作号   (查询某工作号对应的at任务的内容)

6. 删除系统中的at定时任务
命令：atrm [工作号]   (删除指定工作号的at任务)

### 循环定时任务（重要，常用） ###

1. 检查crond服务是否安装
chkconfig --list | grep crond （这是centos7之前的查看方式，centos7之后的是systemctl list-unit-files | grep crond）
service crond status  (查看状态，是否运行)

2. crond服务启动
service crond restart
知识点整理：为什么很多服务后面都有字符'd',这里字符'd'表示位守护进程的意思，证明将这个进程当成系统的服务安装在了系统的后台当中。看到这个'd',就把这个服务当作系统服务。

3. at的访问控制：如果系统中有/etc/crond.allow,这是at命令的白名单，文件中的用户可以使用（有这个文件的话忽略系统中的/etc/crond.deny,这个是crond的黑名单，里面的用户可以使用at，这个文件只有在没有/etc/crond.allow的时候生效，对root没有作用），如果两个文件都没有的话，默认只有root用户有使用权限。默认是有/etc/crond.deney文件
注：/etc/crond.allow和/etc/crond.deney这种机制在linux中是很常见的，所以作用以此类推。

4. 用户的crontab设置
命令：crontab [选项]    (使用当前用户创建crontab循环定时任务，权限不能超出当前用户的权限)
选项：
-e : 编辑crontab定时任务   (注意：'*****执行的任务',都必须写，任意的话用'*',表示，最小有效时间是分钟，最大有效时间是月，大于或小于都不能实现，天数和星期最好不要同时出现，免得把自己搞晕，其次建议定时任务一定要写绝对路径，因为定时任务是由自己的PATH路径的，可能和系统的PATH路径不一致，可能会找不到执行任务)
-l : 查询crontab任务
-r : 删除当前用户所有的crontab任务 (删除一条的话，直接进入crontab -e编辑模式里删除对用行就可以)

   * crontab -e: 进入crontab编辑界面。会打开vim编辑你的工作。
    格式：*****执行的任务 (任务可以时单独的一条命令，也可以是编写好的shell脚本，第一个'*'：一个小时中的第几分钟(0~59)；第二个'*'：一天当中的第几个小时(0~23)；第三个'*'：一个月中的第几天(1~31)；
    第四个'*'：一年中的第几月(1~12)；第五个'*'：一周中的星期几(0~7, 其中1和7都是周日)。)
