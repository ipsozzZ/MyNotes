# MySQL 中的 Undo Log（回滚日志）和 Redo Log（重做日志）区别

 都是 InnoDB 存储引擎实现事务 ACID 特性的核心组件，但二者的设计目标、工作方式和应用场景完全不同。以下是它们的详细对比：

---

### 1. 核心功能区别
| 特性          | Undo Log                          | Redo Log                          |
|--------------------|---------------------------------------|---------------------------------------|
| 核心目标       | 实现事务回滚和多版本并发控制（MVCC） | 确保事务的持久性（Durability）        |
| 作用时机       | 事务执行过程中生成                  | 事务提交前持久化                     |
| 日志类型       | 逻辑日志（记录逆向操作）         | 物理日志（记录物理页修改）       |
| 数据恢复方向   | 逆向恢复（回滚）                     | 正向恢复（重做）                     |

---

### 2. 具体实现细节
#### (1) Undo Log（回滚日志）
- 核心作用：
  - 事务回滚：记录事务修改前的数据版本，用于事务失败时的回滚。
  - MVCC：为其他事务提供一致性读视图（Read View），通过 Undo Log 链访问历史版本。
- 日志内容：
  - 记录事务修改数据的旧版本值（如 `UPDATE` 前的数据）。
  - 对 `INSERT` 操作，记录新插入行的主键，回滚时执行 `DELETE`。
  - 对 `DELETE` 操作，记录完整行数据，回滚时执行 `INSERT`。
  - 对 `UPDATE` 操作，记录被修改字段的旧值，回滚时反向更新。
- 存储方式：
  - 存储在回滚段（Rollback Segment）中，与数据文件分离。
  - 物理上存放在 `ibdata` 系统表空间或独立的 Undo 表空间（MySQL 8.0+）。
- 生命周期：
  - 事务提交后，Undo Log 不会立即删除，而是由后台线程 Purge 按需清理（需确保没有活跃事务依赖该版本）。
  - 长事务可能导致 Undo Log 堆积，引发 `Undo tablespace` 膨胀。

#### (2) Redo Log（重做日志）
- 核心作用：
  - 崩溃恢复：确保已提交事务的修改不丢失，即使系统崩溃也能恢复。
  - Write-Ahead Logging (WAL)：数据修改先写 Redo Log，再写数据文件。
- 日志内容：
  - 记录对数据页的物理修改（如页号、偏移量、修改后的字节）。
  - 采用顺序写入，日志文件循环复用（固定大小，如 `ib_logfile0` 和 `ib_logfile1`）。
- 存储方式：
  - 默认两个文件（`ib_logfile0` 和 `ib_logfile1`），以循环方式写入。
  - 支持配置日志文件大小（`innodb_log_file_size`）和数量（`innodb_log_files_in_group`）。
- 生命周期：
  - 事务提交时，Redo Log 必须持久化到磁盘（通过 `fsync`）。
  - 当 Checkpoint 触发时，Redo Log 中已落盘的数据页可以被覆盖。

---

### 3. 关键对比维度
| 维度           | Undo Log                          | Redo Log                          |
|--------------------|---------------------------------------|---------------------------------------|
| 生成时机       | 事务执行过程中生成                  | 数据修改时生成，事务提交前持久化      |
| 持久化要求     | 不需要立即持久化                    | 事务提交时必须持久化（`innodb_flush_log_at_trx_commit` 控制） |
| 日志清理       | 由 Purge 线程异步清理                | 通过 Checkpoint 标记可覆盖区域         |
| 对性能影响     | 影响回滚和 MVCC 性能                | 影响事务提交延迟（写日志的 I/O 开销）  |
| 可见性         | 对用户不可见（内部维护）            | 对用户不可见（崩溃恢复时自动使用）    |

---

### 4. 协同工作示例
1. 事务执行：
   - 事务修改某行数据时：
     - 生成 Undo Log 记录旧值（用于回滚和 MVCC）。
     - 生成 Redo Log 记录新值的物理修改（用于崩溃恢复）。
2. 事务提交：
   - Redo Log 强制刷盘（确保持久性）。
   - Undo Log 标记为可清理（但可能延迟删除）。
3. 事务回滚：
   - 使用 Undo Log 恢复数据到修改前的状态。
4. 崩溃恢复：
   - 通过 Redo Log 重放已提交但未写入数据文件的操作。
   - 通过 Undo Log 回滚未提交的事务。

---

### 5. 常见问题
#### Q1: 为什么需要同时使用 Undo Log 和 Redo Log？
- Redo Log 解决数据持久化问题（已提交事务的修改不丢失）。
- Undo Log 解决事务原子性（回滚）和读一致性（MVCC）问题。

#### Q2: Undo Log 会占用大量空间吗？
- 可能！长事务或未提交的事务会导致 Undo Log 无法清理，引发空间膨胀。建议：
  - 监控 `SHOW ENGINE INNODB STATUS` 中的 `History list length`。
  - 合理配置 `innodb_undo_tablespaces` 和 `innodb_max_undo_log_size`（MySQL 8.0+）。

#### Q3: Redo Log 刷盘策略如何配置？
- 通过 `innodb_flush_log_at_trx_commit` 控制：
  - `=1`（默认）：每次提交都刷盘（最安全，性能较低）。
  - `=0`：每秒刷盘（可能丢失最近 1 秒的事务）。
  - `=2`：写入 OS 缓存但不刷盘（依赖操作系统刷盘策略）。

---

### 总的来说
- Undo Log 是事务回滚和 MVCC 的基石，记录逻辑逆向操作。
- Redo Log 是崩溃恢复的核心，记录物理修改，确保持久性。
- 二者协同保障了 InnoDB 的事务 ACID 特性，是 MySQL 高可靠性的关键设计。